name: Deploy to Production

on:
  workflow_dispatch:  

jobs:
  deploy-prod:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}
    
    - name: Manual approval for production
      uses: trstringer/manual-approval@v1
      with:
        secret: ${{ github.token }}
        approvers: ${{ secrets.PRODUCTION_APPROVERS }}
        minimum-approvals: 1
    
    - name: Deploy to EC2 (Production)
      env:
        IMAGE_TAG: ${{ github.event.inputs.version || github.sha }}
      run: |
        echo "Starting production deployment..."
        ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.PROD_EC2_HOST }} '
          cd /home/ubuntu/multi-env-cicd-app &&
          AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }} \
          AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }} \
          AWS_REGION=${{ secrets.AWS_REGION }} \
          GITHUB_SHA=$IMAGE_TAG \
          ./scripts/deploy.sh production
        '
    
    - name: Extended health check
      run: |
        echo "Performing extended health checks..."
        ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.PROD_EC2_HOST }} '
          cd /home/ubuntu/multi-env-cicd-app &&
          ./scripts/health-check.sh production
        '
    
    - name: Performance monitoring
      run: |
        echo "Monitoring performance metrics..."
        # Add performance monitoring checks
    
    - name: Send deployment success notification
      if: success()
      uses: 8398a7/action-slack@v3
      with:
        status: success
        author_name: Production Deployment
        text: "Production deployment completed successfully! Version: ${{ github.sha }}"
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}