name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Commit SHA to deploy (from staging)'
        required: true
        type: string
      deployment_type:
        description: 'Deployment type'
        required: true
        type: choice
        options:
          - standard
          - hotfix
        default: standard

jobs:
  deploy-production:
    runs-on: ubuntu-latest
    environment: 
      name: production
      url: http://${{ secrets.PROD_EC2_HOST }}:3000
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        ref: ${{ github.event.inputs.version }}
    
    - name: Deployment info
      run: |
        echo "=================================="
        echo "ğŸš€ PRODUCTION Deployment Started"
        echo "=================================="
        echo "ğŸ“ Deploy SHA: ${{ github.event.inputs.version }}"
        echo "ğŸ‘¤ Triggered by: ${{ github.actor }}"
        echo "ğŸ“… Date: $(date)"
        echo "ğŸ·ï¸ Type: ${{ github.event.inputs.deployment_type }}"
        echo "=================================="
        echo "âš ï¸ PRODUCTION DEPLOYMENT - PROCEED WITH CAUTION"
        echo "=================================="
    
    - name: Pre-deployment checklist
      run: |
        echo "ğŸ“‹ Pre-deployment checklist:"
        echo "  âœ… Staging tests passed?"
        echo "  âœ… Stakeholders notified?"
        echo "  âœ… Rollback plan ready?"
        echo "  âœ… Monitoring tools active?"
        echo ""
        echo "Waiting for environment approval..."
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}
    
    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v1
    
    - name: Setup SSH agent with private key
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.EC2_SSH_KEY }}
    
    - name: Verify image exists in ECR
      env:
        REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        REPOSITORY: multi-env-cicd-app
        IMAGE_TAG: ${{ github.event.inputs.version }}
      run: |
        echo "ğŸ” Verifying image in ECR..."
        
        if docker pull $REGISTRY/$REPOSITORY:$IMAGE_TAG; then
          echo "âœ… Image found and verified"
          echo "ğŸ“¦ Image: $REGISTRY/$REPOSITORY:$IMAGE_TAG"
        else
          echo "âŒ Image not found in ECR!"
          echo "Please ensure staging deployment was successful"
          exit 1
        fi
    
    - name: Backup current production state
      run: |
        echo "ğŸ’¾ Creating backup of current production state..."
        ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.PROD_EC2_HOST }} '
          cd /home/ubuntu/multi-env-cicd-app
          
          # Save current running container info
          docker ps > /tmp/prod-backup-$(date +%Y%m%d-%H%M%S).txt
          
          # Tag current production image as backup
          CURRENT_IMAGE=$(docker ps --format "{{.Image}}" | grep multi-env-cicd-app | head -1)
          if [ ! -z "$CURRENT_IMAGE" ]; then
            docker tag $CURRENT_IMAGE multi-env-cicd-app:last-known-good
            echo "âœ… Backup created: last-known-good"
          fi
        '
        echo "âœ… Backup completed!"
    
    - name: Deploy to EC2
      env:
        IMAGE_TAG: ${{ github.event.inputs.version }}
      run: |
        echo "ğŸš€ Deploying to Production EC2..."
        
        ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.PROD_EC2_HOST }} "
          export AWS_ACCESS_KEY_ID='${{ secrets.AWS_ACCESS_KEY_ID }}'
          export AWS_SECRET_ACCESS_KEY='${{ secrets.AWS_SECRET_ACCESS_KEY }}'
          export AWS_REGION='${{ secrets.AWS_REGION }}'
          
          cd /home/ubuntu/multi-env-cicd-pipeline
          ./scripts/deploy.sh production '${{ secrets.AWS_ACCOUNT_ID }}' '${{ secrets.AWS_REGION }}' '${{ github.event.inputs.version }}'
        "
        echo "âœ… Deployment completed!"
    
    - name: Extended health checks
      run: |
        echo "ğŸ¥ Running extended health checks..."
        sleep 20
        
        # Health check script
        ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.PROD_EC2_HOST }} '
          cd /home/ubuntu/multi-env-cicd-app
          ./scripts/health-check.sh production
        '
        
        # Additional checks
        PROD_URL="http://${{ secrets.PROD_EC2_HOST }}:3000"
        echo "Testing production endpoint: $PROD_URL"
        
        for i in {1..5}; do
          if curl -f $PROD_URL 2>/dev/null; then
            echo "âœ… Health check $i/5 passed"
            sleep 5
          else
            echo "âŒ Health check $i/5 failed"
            exit 1
          fi
        done
        
        echo "âœ… All extended health checks passed!"
    
    - name: Performance monitoring
      run: |
        echo "ğŸ“Š Monitoring initial performance metrics..."
        sleep 30
        
        ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.PROD_EC2_HOST }} '
          echo "CPU Usage:"
          top -bn1 | grep "Cpu(s)" | sed "s/.*, *\([0-9.]*\)%* id.*/\1/" | awk "{print 100 - \$1\"%\"}"
          
          echo "Memory Usage:"
          free -m | awk "NR==2{printf \"%.2f%%\n\", \$3*100/\$2 }"
          
          echo "Disk Usage:"
          df -h | grep -vE "^Filesystem|tmpfs|cdrom" | awk "{ print \$5 \" \" \$1 }"
          
          echo "Docker Stats:"
          docker stats --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}"
        '
        
        echo "âœ… Performance metrics collected"
    
    - name: Create deployment tag
      run: |
        echo "ğŸ·ï¸ Creating deployment tag..."
        
        # Create version tag
        VERSION_TAG="prod-$(date +%Y%m%d-%H%M%S)-${{ github.event.inputs.version }}"
        
        git tag -a $VERSION_TAG -m "Production deployment: ${{ github.event.inputs.deployment_type }}"
        git push origin $VERSION_TAG || echo "âš ï¸ Tag push failed (might need permissions)"
        
        echo "âœ… Tag created: $VERSION_TAG"
    
    - name: Deployment summary
      if: success()
      run: |
        echo "=================================="
        echo "âœ… PRODUCTION DEPLOYMENT SUCCESSFUL"
        echo "=================================="
        echo "ğŸ“¦ Version: ${{ github.event.inputs.version }}"
        echo "ğŸŒ Environment: Production"
        echo "ğŸ·ï¸ Type: ${{ github.event.inputs.deployment_type }}"
        echo "ğŸ‘¤ Deployed by: ${{ github.actor }}"
        echo "ğŸ“… Time: $(date)"
        echo ""
        echo "ğŸ‰ Application is now live in production!"
        echo ""
        echo "ğŸ“Š Next steps:"
        echo "  1. Monitor logs and metrics"
        echo "  2. Watch for errors or anomalies"
        echo "  3. Keep rollback plan ready"
        echo "=================================="
    
    - name: Rollback instructions
      if: failure()
      run: |
        echo "=================================="
        echo "âŒ DEPLOYMENT FAILED"
        echo "=================================="
        echo "ğŸ”„ To rollback, run this workflow again with:"
        echo "   SHA: <previous-working-sha>"
        echo ""
        echo "Or manually rollback:"
        echo "   ssh ${{ secrets.EC2_USER }}@${{ secrets.PROD_EC2_HOST }}"
        echo "   cd /home/ubuntu/multi-env-cicd-app"
        echo "   ./scripts/rollback.sh"
        echo "=================================="
    
    - name: Send Slack notification
      if: always()
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        author_name: Production Deployment
        fields: workflow,job,commit,author
        text: |
          ğŸ”´ PRODUCTION Deployment: ${{ job.status }}
          ğŸ“¦ SHA: `${{ github.event.inputs.version }}`
          ğŸ‘¤ By: ${{ github.actor }}
          ğŸ·ï¸ Type: ${{ github.event.inputs.deployment_type }}
          
          ${{ job.status == 'success' && 'ğŸ‰ Deployment successful! Monitor the application.' || 'âŒ DEPLOYMENT FAILED! Check logs immediately!' }}
          ${{ job.status == 'failure' && 'ğŸ”„ Rollback may be required!' || '' }}
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}